generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============ USERS & AUTH ============

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String
  firstName       String
  lastName        String
  phone           String?
  role            String   @default("VOLUNTEER") // ADMIN, MANAGER, SPONSOR, VOLUNTEER
  isActive        Boolean  @default(true)
  variableSymbol  String?  // VS přidělený sponzorovi (pro párování plateb)
  bankAccount     String?  // číslo účtu sponzora (pro párování plateb)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sponsorships     Sponsorship[]
  assignedStudents VolunteerAssignment[]
  sponsorPayments  SponsorPayment[]
  voucherPurchases VoucherPurchase[] @relation("VoucherSponsor")
  paymentImports   PaymentImport[]   @relation("PaymentImports")
  importRowSponsor PaymentImportRow[] @relation("ImportRowSponsor")
}

// ============ STUDENTS ============

model Student {
  id           String   @id @default(cuid())
  studentNo    String   @unique
  firstName    String
  lastName     String
  dateOfBirth  DateTime?
  gender       String?
  className    String?
  school       String?  // School name (e.g. "Rael", "Unga Primary", "Kodida Primary")
  orphanStatus String?  // "total", "partial", or null
  healthStatus String?
  profilePhoto String?  // Path to profile photo

  motherName   String?
  motherAlive  Boolean?
  fatherName   String?
  fatherAlive  Boolean?
  siblings     String?

  isActive     Boolean  @default(true)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  equipment       Equipment[]
  needs           Need[]
  photos          Photo[]
  vouchers        VoucherPurchase[]
  voucherUsages   VoucherUsage[]
  sponsorships    Sponsorship[]
  healthChecks    HealthCheck[]
  payments        Payment[]
  volunteers      VolunteerAssignment[]
  sponsorPayments SponsorPayment[]
  importRows      PaymentImportRow[]
  wishes          Wish[]
}

// ============ EQUIPMENT ============

model Equipment {
  id         String   @id @default(cuid())
  studentId  String
  type       String
  condition  String
  acquiredAt DateTime?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

// ============ NEEDS ============

model Need {
  id          String   @id @default(cuid())
  studentId   String
  description String
  isFulfilled Boolean  @default(false)
  fulfilledAt DateTime?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

// ============ PHOTOS ============

model Photo {
  id          String   @id @default(cuid())
  studentId   String
  category    String
  fileName    String
  filePath    String
  description String?
  takenAt     DateTime @default(now())
  createdAt   DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

// ============ VOUCHERS ============

model VoucherPurchase {
  id           String   @id @default(cuid())
  studentId    String
  purchaseDate DateTime
  amount       Float
  count        Int
  donorName    String?  // Name of the person who donated (legacy)
  sponsorId    String?
  notes        String?
  source       String?  // "manual" | "bankImport"
  importRowId  String?  // odkaz na PaymentImportRow.id
  createdAt    DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sponsor User?   @relation("VoucherSponsor", fields: [sponsorId], references: [id], onDelete: SetNull)
}

model VoucherUsage {
  id        String   @id @default(cuid())
  studentId String
  usageDate DateTime
  count     Int
  notes     String?
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

// ============ SPONSORS ============

model Sponsorship {
  id        String   @id @default(cuid())
  studentId String
  userId    String
  startDate DateTime @default(now())
  endDate   DateTime?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sponsor User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============ HEALTH CHECKS ============

model HealthCheck {
  id        String   @id @default(cuid())
  studentId String
  checkDate DateTime
  checkType String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

// ============ PAYMENTS ============

model Payment {
  id          String   @id @default(cuid())
  studentId   String?
  paymentDate DateTime
  amount      Float
  notes       String?
  source      String?
  createdAt   DateTime @default(now())

  student Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
}

// ============ SPONSOR PAYMENTS ============

model SponsorPayment {
  id          String   @id @default(cuid())
  studentId   String
  sponsorId   String?
  paymentDate DateTime
  amount      Float
  currency    String   @default("KES")
  paymentType String   // tuition, medical, other
  notes       String?
  source      String?  // "manual" | "bankImport"
  importRowId String?  // odkaz na PaymentImportRow.id
  createdAt   DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sponsor User?   @relation(fields: [sponsorId], references: [id], onDelete: SetNull)
}

// ============ VOLUNTEER ASSIGNMENTS ============

model VolunteerAssignment {
  id        String   @id @default(cuid())
  userId    String
  studentId String
  createdAt DateTime @default(now())

  volunteer User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([userId, studentId])
}

// ============ CLASS ROOMS ============

model ClassRoom {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ============ HEALTH CHECK TYPES ============

model HealthCheckType {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ============ PAYMENT TYPES ============

model PaymentType {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ============ NEED TYPES ============

model NeedType {
  id        String   @id @default(cuid())
  name      String   @unique
  price     Float?   // Orientační cena v CZK
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ============ EQUIPMENT TYPES ============

model EquipmentType {
  id        String   @id @default(cuid())
  name      String   @unique
  price     Float?   // Orientační cena v CZK
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

// ============ WISH TYPES ============

model WishType {
  id        String   @id @default(cuid())
  name      String   @unique
  price     Float?   // Orientační cena v CZK
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  wishes    Wish[]
}

// ============ WISHES ============

model Wish {
  id          String    @id @default(cuid())
  studentId   String
  wishTypeId  String?
  description String
  isFulfilled Boolean   @default(false)
  fulfilledAt DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  student  Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  wishType WishType? @relation(fields: [wishTypeId], references: [id], onDelete: SetNull)
}

// ============ PAYMENT IMPORTS ============

model PaymentImport {
  id            String    @id @default(cuid())
  fileName      String                // původní název souboru
  fileType      String                // "csv", "pdf", "xlsx"
  statementDate DateTime?             // datum výpisu (z hlavičky)
  importedById  String                // kdo importoval (User.id)
  totalRows     Int       @default(0)
  matchedRows   Int       @default(0)
  status        String    @default("PROCESSING") // PROCESSING, READY, COMPLETED, CANCELLED
  createdAt     DateTime  @default(now())

  importedBy User               @relation("PaymentImports", fields: [importedById], references: [id])
  rows       PaymentImportRow[]
}

model PaymentImportRow {
  id              String   @id @default(cuid())
  importId        String

  // --- Surová data z výpisu ---
  transactionDate DateTime
  amount          Float
  currency        String   @default("CZK")
  variableSymbol  String?
  senderName      String?
  senderAccount   String?
  message         String?
  rawData         String?              // celý originální řádek jako JSON

  // --- Výsledky párování ---
  status          String   @default("NEW") // NEW, MATCHED, PARTIAL, APPROVED, REJECTED, DUPLICATE, SPLIT
  sponsorId       String?
  studentId       String?
  paymentTypeId   String?
  matchConfidence String   @default("NONE") // NONE, LOW, MEDIUM, HIGH
  matchNotes      String?              // popis jak byl match proveden

  // --- Stravenky ---
  voucherCount    Int?                 // manuálně zadaný počet stravenek

  // --- Split platba ---
  parentRowId     String?              // pokud child → odkaz na původní řádek

  // --- Duplikát ---
  duplicateOfId   String?              // odkaz na existující SponsorPayment.id

  // --- Schválení ---
  approvedById    String?
  approvedAt      DateTime?
  resultPaymentId String?              // vytvořený SponsorPayment.id / VoucherPurchase.id

  createdAt       DateTime @default(now())

  import       PaymentImport       @relation(fields: [importId], references: [id], onDelete: Cascade)
  sponsor      User?               @relation("ImportRowSponsor", fields: [sponsorId], references: [id])
  student      Student?            @relation(fields: [studentId], references: [id])
  parentRow    PaymentImportRow?   @relation("SplitRows", fields: [parentRowId], references: [id])
  splitRows    PaymentImportRow[]  @relation("SplitRows")
}
